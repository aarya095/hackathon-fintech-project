datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

model User {
  id        Int    @id @default(autoincrement())
  name      String
  email     String @unique
  password  String
  timezone  String? @default("UTC")

  arrangementsAsLender   Arrangement[] @relation("Lender")
  arrangementsAsBorrower Arrangement[] @relation("Borrower")
  recordedPayments       Payment[]     @relation("RecordedPayments")
  confirmedPayments      Payment[]     @relation("ConfirmedPayments")
  reminders              Reminder[]    @relation("Reminders")
  proposals              Proposal[]    @relation("Proposals")
}

model Arrangement {
  id             Int       @id @default(autoincrement())
  title          String
  totalAmount    Float
  currency       String    @default("INR")
  expectedBy     DateTime?
  repaymentStyle String    // one_time | installments | flexible
  note           String?
  status         String    @default("pending") // pending | active | closed
  closedAt       DateTime?
  closedMessage  String?
  createdAt      DateTime  @default(now())

  lenderId   Int
  lender     User   @relation("Lender", fields: [lenderId], references: [id])
  borrowerId Int
  borrower   User   @relation("Borrower", fields: [borrowerId], references: [id])

  payments   Payment[]
  reminders  Reminder[]
  proposals  Proposal[]
  activities Activity[]
}

model Payment {
  id            Int       @id @default(autoincrement())
  amount        Float
  paidOn        DateTime
  note          String?
  status        String    @default("pending_confirmation") // pending_confirmation | confirmed
  confirmedAt   DateTime?
  recordedAt    DateTime  @default(now())

  arrangementId Int
  arrangement   Arrangement @relation(fields: [arrangementId], references: [id], onDelete: Cascade)
  recordedById  Int
  recordedBy    User     @relation("RecordedPayments", fields: [recordedById], references: [id])
  confirmedById Int?
  confirmedBy   User?    @relation("ConfirmedPayments", fields: [confirmedById], references: [id])
}

model Reminder {
  id            Int       @id @default(autoincrement())
  schedule      String    // monthly | weekly | custom
  messageTone   String    @default("gentle") // gentle | friendly | etc.
  customMessage String?
  nextTrigger   DateTime?
  status        String    @default("active") // active | snoozed
  snoozeUntil   DateTime?
  visibleNote   String?   // reason when snoozed

  arrangementId Int
  arrangement   Arrangement @relation(fields: [arrangementId], references: [id], onDelete: Cascade)
  createdById   Int
  createdBy     User     @relation("Reminders", fields: [createdById], references: [id])
}

model Proposal {
  id            Int       @id @default(autoincrement())
  type          String    // expectedByChange | etc.
  newExpectedBy DateTime?
  reason        String?
  status        String    @default("pending") // pending | accepted | rejected

  arrangementId Int
  arrangement   Arrangement @relation(fields: [arrangementId], references: [id], onDelete: Cascade)
  proposedById  Int
  proposedBy    User     @relation("Proposals", fields: [proposedById], references: [id])
}

model Activity {
  id            Int      @id @default(autoincrement())
  type          String   // payment_confirmed | payment_recorded | proposal_accepted | arrangement_created | etc.
  actorRole     String   // lender | borrower
  message       String
  metadata      String?  // JSON for extra data

  arrangementId Int
  arrangement   Arrangement @relation(fields: [arrangementId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
}
